{% extends 'base.html' %}

{% block title %}{% if form.instance.pk %}ویرایش محصول{% else %}افزودن محصول جدید{% endif %}{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow border-0 rounded-4 animate__animated animate__fadeInUp">
                <div class="card-header bg-primary text-white py-3 rounded-top-4">
                    <h5 class="mb-0 fw-bold">
                        {% if form.instance.pk %}
                            <i class="bi bi-pencil-square"></i> ویرایش محصول: {{ form.instance.name }}
                        {% else %}
                            <i class="bi bi-plus-circle"></i> افزودن محصول جدید
                        {% endif %}
                    </h5>
                </div>
                <div class="card-body p-4">
                    <form method="post" enctype="multipart/form-data">
                        {% csrf_token %}
                        
                        {% if form.errors %}
                        <div class="alert alert-danger">
                            لطفاً خطاهای زیر را برطرف کنید:
                            <ul class="mb-0 small">
                            {% for field in form %}
                                {% for error in field.errors %}
                                    <li>{{ field.label }}: {{ error }}</li>
                                {% endfor %}
                            {% endfor %}
                            </ul>
                        </div>
                        {% endif %}

                        <div class="row g-3">
                            <div class="col-md-12">
                                <label class="form-label">نام محصول *</label>
                                {{ form.name }}
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">دسته‌بندی *</label>
                                {{ form.category }}
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">قیمت پایه (تومان) *</label>
                                {{ form.base_price }}
                            </div>

                            <div class="col-12 mt-4">
                                <div class="card bg-light border-0">
                                    <div class="card-header bg-transparent d-flex justify-content-between align-items-center">
                                        <h6 class="mb-0 fw-bold text-dark"><i class="bi bi-palette"></i> تنوع محصول (رنگ و سایز)</h6>
                                        <button type="button" class="btn btn-sm btn-success" onclick="addVariantRow()">
                                            <i class="bi bi-plus-lg"></i> افزودن تنوع جدید
                                        </button>
                                    </div>
                                    <div class="card-body p-2">
                                        <div class="row g-2 mb-2 text-muted small px-2">
                                            <div class="col-3">رنگ (مثال: قرمز)</div>
                                            <div class="col-3">سایز (مثال: XL)</div>
                                            <div class="col-3">موجودی</div>
                                            <div class="col-2">تفاوت قیمت</div>
                                            <div class="col-1"></div>
                                        </div>
                                        
                                        <div id="variants-container">
                                            <div class="variant-row row g-2 mb-2 align-items-center bg-white p-2 rounded shadow-sm">
                                                <div class="col-3">
                                                    <input type="text" name="vars_color[]" class="form-control form-control-sm" placeholder="رنگ" required>
                                                </div>
                                                <div class="col-3">
                                                    <input type="text" name="vars_size[]" class="form-control form-control-sm" placeholder="سایز" required>
                                                </div>
                                                <div class="col-3">
                                                    <input type="number" name="vars_stock[]" class="form-control form-control-sm" placeholder="0" min="0" required>
                                                </div>
                                                <div class="col-2">
                                                    <input type="number" name="vars_price[]" class="form-control form-control-sm" placeholder="0" value="0">
                                                </div>
                                                <div class="col-1 text-end">
                                                    <button type="button" class="btn btn-text text-danger" onclick="removeRow(this)">
                                                        <i class="bi bi-trash"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 mt-4">
                                <label class="form-label">برند</label>
                                {{ form.brand }}
                            </div>

                            <div class="col-md-6 mt-4">
                                <label class="form-label">جنس پارچه</label>
                                {{ form.material }}
                            </div>

                            <div class="col-12">
                                <label class="form-label">توضیحات محصول</label>
                                {{ form.description }}
                            </div>

                            <div class="col-12 border-top pt-3 mt-2">
                                <h6 class="mb-3 fw-bold text-muted">تصاویر محصول</h6>
                                <div class="row g-3">
                                    {% for field in form %}
                                        {% if field.name == 'image1' or field.name == 'image2' or field.name == 'image3' %}
                                        <div class="col-md-4">
                                            <label class="form-label small">{{ field.label }}</label>
                                            
                                            <div class="upload-box text-center">
                                                <label for="{{ field.id_for_label }}" class="btn btn-outline-primary w-100 cursor-pointer">
                                                    <i class="bi bi-cloud-arrow-up"></i> انتخاب تصویر
                                                </label>
                                                
                                                <div style="height: 0; overflow: hidden;">
                                                    {{ field }} 
                                                </div>

                                                <div id="file-name-{{ field.id_for_label }}" class="text-muted small mt-2 text-truncate" dir="ltr">
                                                    {% if field.value %}
                                                        <span class="text-success"><i class="bi bi-check-circle"></i> تصویر موجود است</span>
                                                    {% else %}
                                                        هنوز انتخابی نشده
                                                    {% endif %}
                                                </div>
                                            </div>
                                            
                                            {% if field.errors %}
                                            <div class="text-danger small mt-1">{{ field.errors }}</div>
                                            {% endif %}
                                        </div>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                            </div>

                            <div class="col-12 mt-3">
                                <div class="form-check form-switch p-3 bg-light rounded-3">
                                    {{ form.is_active }}
                                    <label class="form-check-label ms-2" for="{{ form.is_active.id_for_label }}">
                                        انتشار محصول در فروشگاه (فعال)
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4 pt-3 border-top">
                            <a href="{% url 'frontend:seller-products' %}" class="btn btn-light me-md-2 border">انصراف</a>
                            <button type="submit" class="btn btn-primary px-5 fw-bold">ذخیره محصول</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
    const fileInputs = document.querySelectorAll('input[type="file"]');
    fileInputs.forEach(input => {
        input.addEventListener('change', function(e) {
            const fileName = e.target.files[0] ? e.target.files[0].name : "فایلی انتخاب نشده";
            const displayBox = document.getElementById('file-name-' + input.id);
            if (displayBox) {
                displayBox.textContent = fileName;
                displayBox.classList.add('text-dark');
            }
        });
    });
});

function addVariantRow() {
    const container = document.getElementById('variants-container');
    const newRow = document.createElement('div');
    newRow.className = 'variant-row row g-2 mb-2 align-items-center bg-white p-2 rounded shadow-sm animate__animated animate__fadeIn';
    newRow.innerHTML = `
        <div class="col-3">
            <input type="text" name="vars_color[]" class="form-control form-control-sm" placeholder="رنگ" required>
        </div>
        <div class="col-3">
            <input type="text" name="vars_size[]" class="form-control form-control-sm" placeholder="سایز" required>
        </div>
        <div class="col-3">
            <input type="number" name="vars_stock[]" class="form-control form-control-sm" placeholder="0" min="0" required>
        </div>
        <div class="col-2">
            <input type="number" name="vars_price[]" class="form-control form-control-sm" placeholder="0" value="0">
        </div>
        <div class="col-1 text-end">
            <button type="button" class="btn btn-text text-danger" onclick="removeRow(this)">
                <i class="bi bi-trash"></i>
            </button>
        </div>
    `;
    container.appendChild(newRow);
}

function removeRow(btn) {
    const rows = document.getElementsByClassName('variant-row');
    if (rows.length > 1) {
        btn.closest('.variant-row').remove();
    } else {
        alert("حداقل یک تنوع باید وجود داشته باشد.");
    }
}
</script>
{% endblock %}